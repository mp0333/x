name: "CI/CD: Windows Build Agent (V75 - Stable & Debug)"

on:
  workflow_dispatch:

jobs:
  build-agent-deploy:
    name: "Deploying V10 Agent..."
    runs-on: windows-latest
    timeout-minutes: 360

    env:
      TS_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      PASS: ${{ secrets.RDP_PASSWORD }}
      TG_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TG_CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}
      
      # FORTNITE V10 LINK
      TOOL_URL: "https://www.dropbox.com/scl/fi/rsal1kle2a2hmvmrcvcgy/Fortnite-V10.zip?rlkey=d5fecjla135uxn964duul8yng&st=k8clogsx&dl=1"
      
      LINK_A: "https://fn-sorter-pro.streamlit.app/"
      LINK_B: "https://miri1408x-create.github.io/txt-merger/"

    steps:
      - name: "âš¡ System Tuning"
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop' # Halt on any error for debugging
          Write-Host "ðŸš€ Configuring System..."

          # 1. NUKE DEFENDER
          Set-MpPreference -DisableRealtimeMonitoring $true -Force
          Set-MpPreference -DisableIOAVProtection $true -Force
          Set-MpPreference -DisableArchiveScanning $true -Force
          
          # 2. INSTALL 7-ZIP
          choco install 7zip -y --no-progress --limit-output

          # 3. STEALTH DNS & NETWORKING
          $interface = Get-NetAdapter | Where-Object { $_.Status -eq 'Up' }
          Set-DnsClientServerAddress -InterfaceIndex $interface.InterfaceIndex -ServerAddresses ("1.1.1.1", "8.8.8.8")
          
          # TCP Optimization
          netsh int tcp set global autotuninglevel=normal
          netsh int tcp set global congestionprovider=ctcp
          
          # 4. RDP SECURITY
          $tsKey = "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp"
          Set-ItemProperty -Path $tsKey -Name "UserAuthentication" -Value 1 -Type DWord -Force
          Set-ItemProperty -Path $tsKey -Name "SecurityLayer" -Value 2 -Type DWord -Force

          # 5. VISUALS
          $polKey = "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services"
          if (!(Test-Path $polKey)) { New-Item -Path $polKey -Force | Out-Null }
          Set-ItemProperty -Path $polKey -Name "fDisableWallpaper" -Value 1 -Type DWord -Force
          Set-ItemProperty -Path $polKey -Name "fDisableThemes" -Value 1 -Type DWord -Force

          # 6. CREATE USER
          if (-not $env:PASS) { Write-Error "âŒ ERROR: RDP_PASSWORD Secret is Missing!"; exit 1 }
          $secPass = ConvertTo-SecureString $env:PASS -AsPlainText -Force
          New-LocalUser -Name "RDP" -Password $secPass -Description "Agent" -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "RDP"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          
          Write-Host "âœ… System Ready."

      - name: "ðŸŒ Connect Tailscale (Debug Mode)"
        shell: pwsh
        run: |
          if (-not $env:TS_KEY) { Write-Error "âŒ ERROR: TAILSCALE_AUTH_KEY is Missing!"; exit 1 }
          
          # Install
          choco install tailscale -y --no-progress --skip-virus-check --ignore-checksums --limit-output
          
          # Connect with Timeout protection
          Write-Host "Connecting to Tailscale..."
          try {
            & "C:\Program Files\Tailscale\tailscale.exe" up --authkey="$env:TS_KEY" --hostname="Agent-$env:GITHUB_RUN_ID" --unattended --accept-routes --timeout=30s
          } catch {
            Write-Error "âŒ Tailscale failed to connect. Check your Key."
            exit 1
          }

          Start-Sleep -Seconds 5
          $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          echo "AGENT_IP=$ip" >> $env:GITHUB_ENV
          
          # --- TELEGRAM MESSAGE ---
          if ($env:TG_TOKEN -and $env:TG_CHAT) {
              $msgTemplate = "ðŸ”¥ *RDP ONLINE (V75)*`n`nIP: ``{0}
